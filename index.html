<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>呷安全 (K+ Guard) 網頁版</title>
<style>
  body { font-family: sans-serif; margin:0; padding:0; background:#f8f8f8; }
  header { background:#4caf50; color:white; padding:12px 16px; display:flex; justify-content:space-between; align-items:center; }
  main { padding:16px; max-width:800px; margin:auto; }
  h2 { margin-top:24px; }
  input[type=text], input[type=number], input[type=email] { width:100%; padding:8px; margin:4px 0; border:1px solid #ccc; border-radius:4px; }
  button { padding:8px 12px; margin:4px; border:none; border-radius:4px; cursor:pointer; }
  button.primary { background:#4caf50; color:white; }
  button.danger { background:#f44336; color:white; }
  .progress-container { background:#ddd; border-radius:12px; overflow:hidden; margin:4px 0; }
  .progress-bar { height:16px; width:0%; background:#4caf50; }
  .food-item { padding:8px; margin:4px 0; background:white; border-radius:6px; display:flex; justify-content:space-between; align-items:center; cursor:pointer; }
  .badge { padding:4px 8px; border-radius:12px; font-weight:bold; color:white; }
  .low { background:#4caf50; }
  .medium { background:#ff9800; }
  .high { background:#f44336; }
  .cb-low { background:#2196f3; }
  .cb-medium { background:#795548; }
  .cb-high { background:#000; }
  .record { padding:6px; margin:4px 0; background:white; border-radius:6px; display:flex; justify-content:space-between; align-items:center; }
  .flex { display:flex; gap:8px; align-items:center; }
  img.preview { max-width:100%; border-radius:12px; margin-top:8px; }
</style>
</head>
<body>

<header>
  <div>呷安全 (K+ Guard)</div>
  <div>
    <label><input type="checkbox" id="colorBlind"> 色盲模式</label>
  </div>
</header>

<main>
  <!-- 今日進度 -->
  <h2>今日累積鉀攝取</h2>
  <div id="todayTotal">0 / 2000 mg</div>
  <div class="progress-container">
    <div class="progress-bar" id="progressBar"></div>
  </div>

  <!-- 拍照上傳 -->
  <h2>拍照上傳與 AI 辨識</h2>
  <div class="flex">
    <input type="text" id="barcodeInput" placeholder="輸入條碼或名稱 (可選)">
    <button class="primary" onclick="uploadAndAnalyzeImage()">拍照並上傳分析</button>
  </div>
  <input type="file" accept="image/*" id="imageInput" capture="environment">
  
  <img id="preview" class="preview" src="" alt="">
  <!-- 顯示上傳結果的區域 -->
  <div id="aiResult" style="margin-top: 10px; font-weight: bold;"></div>
  <div id="aiConfidence" style="font-size: 0.9em; color: gray;"></div>


  <!-- 搜尋結果 -->
  <h2>搜尋食物(有2000多種食物，只顯示前10筆)</h2>
  <input type="text" id="searchInput" placeholder="輸入食物名稱或別名">
  <div id="searchResults"></div>

  <!-- 今日紀錄 -->
  <h2>今日紀錄</h2>
  <div id="records"></div>
  <button class="danger" onclick="clearRecords()">清空今日紀錄</button>

  <!-- 每日上限 -->
  <h2>每日鉀攝取上限設定</h2>
  <input type="number" id="dailyLimitInput" value="2000">
  <button class="primary" onclick="saveDailyLimit()">儲存</button>
</main>

<script>
// --- 全域變數 ---
let foods = [];
let records = JSON.parse(localStorage.getItem('kRecords')||'[]');
let dailyLimit = parseFloat(localStorage.getItem('kDailyLimit')||'2000');
let barcodeMap = JSON.parse(localStorage.getItem('kBarcodeMap')||'{}');
let colorBlindMode = false;

// --- DOM ---
const todayTotalEl = document.getElementById('todayTotal');
const progressBarEl = document.getElementById('progressBar');
const searchInput = document.getElementById('searchInput');
const searchResultsEl = document.getElementById('searchResults');
const recordsEl = document.getElementById('records');
const dailyLimitInput = document.getElementById('dailyLimitInput');
const barcodeInput = document.getElementById('barcodeInput');
const imageInput = document.getElementById('imageInput');
const previewImg = document.getElementById('preview');
const colorBlindCheck = document.getElementById('colorBlind');
const aiResultEl = document.getElementById('aiResult');
const aiConfidenceEl = document.getElementById('aiConfidence');

// *** 請將這裡的 URL 替換為你在 Google Apps Script 部署後得到的網路應用程式 URL！ ***
const GAS_WEB_APP_URL = "https://billowing-rain-a2b1.jacky-39e.workers.dev/"; 
// 食物資料 API URL，現在指向同一個 GAS 部署，但會呼叫 doGet
const FOOD_DATA_API_URL = GAS_WEB_APP_URL; 

// --- 從 Apps Script API 載入資料 ---
async function loadFoodData() {
  try {
    const res = await fetch("https://script.google.com/macros/s/AKfycbyhZIW1GL-y1-0SQFcj8XZ8YPsW2LAIsccc-_KXkKzYWc8QIvZlCBeoVW_B8ZoGCrcwug/exec");
    foods = await res.json();
    renderSearchResults();
  } catch (err) {
    console.error("載入 FoodData 失敗:", err);
    searchResultsEl.innerHTML = "<div style='color:red'>無法載入食物資料</div>";
  }
}
  
// --- 渲染搜尋結果 ---
function renderSearchResults() {
  const q = searchInput.value.trim().toLowerCase();
  const results = q=='' ? foods : foods.filter(f => 
    f.name.toLowerCase().includes(q) || 
    (f.alias && f.alias.some(a => a.toLowerCase().includes(q)))
  );
  searchResultsEl.innerHTML = '';
  results.slice(0, 10).forEach(f => {
    const div = document.createElement('div');
    div.className = 'food-item';
    div.innerHTML = `
      <span>${f.name} (${f.k ?? '未知'} mg/100g)</span>
      <span class="badge ${levelClass(f.k)}">
        ${f.k==null?'未知':f.k<=100?'低鉀':f.k<=200?'中鉀':'高鉀'}
      </span>`;
    div.onclick = () => addRecord(f);
    searchResultsEl.appendChild(div);
  });
}

// --- 判斷鉀等級 ---
function levelClass(k){
  if(k==null) return 'medium'; // 預設未知為中鉀
  if(colorBlindMode) return k<=100?'cb-low':k<=200?'cb-medium':'cb-high';
  return k<=100?'low':k<=200?'medium':'high';
}

// --- 紀錄操作 ---
function saveRecords(){ localStorage.setItem('kRecords', JSON.stringify(records)); }
function saveDailyLimit(){ dailyLimit = parseFloat(dailyLimitInput.value)||2000; localStorage.setItem('kDailyLimit', dailyLimit); updateTodayTotal(); alert('每日上限已更新'); }
function clearRecords(){ records=[]; saveRecords(); renderRecords(); updateTodayTotal(); }
function addRecord(food, grams=100){
  const k = food.k!=null ? food.k*grams/100 : null;
  const now = new Date().toISOString();
  records.push({id:food.id,name:food.name,grams,k,ts:now});
  saveRecords(); renderRecords(); updateTodayTotal();
  alert(`已加入今日紀錄：${food.name} ${grams}g`);
}
function updateTodayTotal(){
  const today = new Date().toISOString().split('T')[0]; // 獲取今天的日期部分
  const todayRecords = records.filter(r => r.ts.startsWith(today)); // 過濾出今天的紀錄
  const total = todayRecords.reduce((s,r)=>s+(r.k||0),0);

  todayTotalEl.textContent = `${Math.round(total)} / ${Math.round(dailyLimit)} mg`;
  const ratio = Math.min(total/dailyLimit,1);
  progressBarEl.style.width = (ratio*100)+'%';
  progressBarEl.style.background = colorBlindMode ? '#2196f3' : (total>dailyLimit?'#f44336':'#4caf50');
}
function renderRecords(){
  recordsEl.innerHTML='';
  const today = new Date().toISOString().split('T')[0];
  const todayRecords = records.filter(r => r.ts.startsWith(today));
  todayRecords.slice().reverse().forEach(r=>{
    const el = document.createElement('div'); el.className='record';
    el.innerHTML = `<div>${r.name} ${r.grams}g → ${Math.round(r.k||0)} mg</div><div>${r.ts.substr(11,5)}</div>`;
    recordsEl.appendChild(el);
  });
}


/**
 * 上傳圖片到 Google Drive 並使用 Gemini 進行圖片分析
 */
async function uploadAndAnalyzeImage() {
  const file = imageInput.files[0];
  if (!file) {
    alert('請先選擇一張圖片！');
    return;
  }

  aiResultEl.textContent = '正在處理圖片，請稍候...';
  aiResultEl.style.color = 'gray';
  aiConfidenceEl.textContent = '';

  const reader = new FileReader();
  reader.onloadend = async () => {
    // 獲取 Base64 資料，並移除前綴 "data:image/jpeg;base64,"
    const base64Data = reader.result.split(',')[1]; 
    const fileName = `upload_${new Date().getTime()}.${file.name.split('.').pop()}`;
    const userPrompt = "請告訴我這張圖中有什麼食物或水果？如果可以，請列出常見的食物名稱，並只回答食物名稱，不要有其他描述。"; 

    try {
      // 步驟 1: 上傳圖片到 Google Drive (可選)
      // 這一步驟可以選擇性地移除，如果只是想用 Gemini 進行分析而不儲存圖片。
      aiResultEl.textContent = '正在上傳圖片到 Google Drive...';
      const uploadResponse = await fetch(GAS_WEB_APP_URL, {
        method: 'POST',
        mode: 'cors',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ 
          action: 'uploadImage', 
          imageData: base64Data, 
          fileName: fileName, 
          mimeType: file.type 
        }),
      });

      const uploadResult = await uploadResponse.json();

      if (uploadResult.status === 'success') {
        console.log('檔案 ID:', uploadResult.fileId);
        aiResultEl.textContent = '圖片已上傳到 Google Drive。正在進行 AI 分析...';
        aiResultEl.style.color = 'green';

        // 步驟 2: 調用 Gemini 進行圖片分析
        const analyzeResponse = await fetch(GAS_WEB_APP_URL, {
          method: 'POST',
          mode: 'cors',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ 
            action: 'analyzeImage', 
            imageData: base64Data, 
            prompt: userPrompt 
          }),
        });

        const analyzeResult = await analyzeResponse.json();

        if (analyzeResult.status === 'success') {
          aiResultEl.textContent = `AI 分析結果: ${analyzeResult.result}`;
          aiResultEl.style.color = 'blue';
          console.log('AI 分析結果:', analyzeResult.result);

          // 嘗試根據 AI 辨識結果自動搜尋食物
          if (analyzeResult.result) {
            searchInput.value = analyzeResult.result;
            renderSearchResults();
          }

        } else {
          aiResultEl.textContent = `AI 分析失敗：${analyzeResult.message || '未知錯誤'}`;
          aiResultEl.style.color = 'red';
          console.error('Gemini 分析錯誤:', analyzeResult.message);
        }

      } else {
        aiResultEl.textContent = `上傳 GDRIVE 失敗：${uploadResult.message || '未知錯誤'}`;
        aiResultEl.style.color = 'red';
        console.error('Apps Script 上傳錯誤:', uploadResult.message);
      }
    } catch (error) {
      aiResultEl.textContent = '處理過程中發生錯誤。';
      aiResultEl.style.color = 'red';
      console.error('圖片處理錯誤:', error);
    }
  };
  reader.readAsDataURL(file);
}

// --- 事件 & 初始化 ---
searchInput.addEventListener('input', renderSearchResults);
colorBlindCheck.addEventListener('change', ()=>{ 
  colorBlindMode=colorBlindCheck.checked; 
  localStorage.setItem('kColorBlindMode', colorBlindMode); // 保存色盲模式設定
  renderSearchResults(); 
  updateTodayTotal(); 
});

// 頁面載入初始化
loadFoodData();
renderRecords();
updateTodayTotal();
dailyLimitInput.value=dailyLimit; 

// 從 localStorage 載入色盲模式設定
const storedColorBlindMode = localStorage.getItem('kColorBlindMode');
if (storedColorBlindMode !== null) {
  colorBlindMode = JSON.parse(storedColorBlindMode);
  colorBlindCheck.checked = colorBlindMode;
}

// --- 圖片選擇時預覽 ---
imageInput.addEventListener('change', function() {
  const file = this.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = function(e) {
      previewImg.src = e.target.result;
      previewImg.style.display = 'block';
    };
    reader.readAsDataURL(file);
  } else {
    previewImg.src = '';
    previewImg.style.display = 'none';
  }
});

  
</script>
</body>
</html>
